// Smart Med Assistant - Backend API Server
// Node.js + Express + PostgreSQL

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { Pool } = require('pg');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');

const app = express();
const PORT = process.env.PORT || 3000;

// ============================================
// Database Connection Pool
// ============================================
const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”
pool.connect((err, client, release) => {
  if (err) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº PostgreSQL:', err.stack);
  } else {
    console.log('âœ… PostgreSQL Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾');
    release();
  }
});

// ============================================
// Middleware
// ============================================
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || '*',
  credentials: true
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

// ============================================
// Auth Middleware
// ============================================
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½' });
  }

  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({ error: 'ÐÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½' });
    }
    req.user = user;
    next();
  });
};

// ============================================
// ROUTES
// ============================================

// Health Check
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    server: '194.87.0.45',
    database: 'connected'
  });
});

// ============================================
// AUTH ENDPOINTS
// ============================================

// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.post('/api/auth/register', async (req, res) => {
  const { email, password, role, full_name } = req.body;

  try {
    // Ð¥ÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ
    const password_hash = await bcrypt.hash(password, 10);
    
    // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ invite_code Ð´Ð»Ñ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð²
    const invite_code = Math.random().toString(36).substring(2, 10).toUpperCase();

    const client = await pool.connect();
    
    try {
      await client.query('BEGIN');

      // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      const userResult = await client.query(
        `INSERT INTO users (email, password_hash, role, invite_code) 
         VALUES ($1, $2, $3, $4) RETURNING id`,
        [email, password_hash, role, invite_code]
      );

      const userId = userResult.rows[0].id;

      // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
      await client.query(
        `INSERT INTO profiles (user_id, full_name) VALUES ($1, $2)`,
        [userId, full_name]
      );

      await client.query('COMMIT');

      res.status(201).json({
        message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½',
        userId,
        inviteCode: role === 'patient' ? invite_code : null
      });

    } catch (err) {
      await client.query('ROLLBACK');
      throw err;
    } finally {
      client.release();
    }

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸' });
  }
});

// Ð’Ñ…Ð¾Ð´ (Login)
app.post('/api/auth/login', async (req, res) => {
  const { email, password } = req.body;

  try {
    const result = await pool.query(
      `SELECT u.id, u.email, u.password_hash, u.role, p.full_name 
       FROM users u 
       LEFT JOIN profiles p ON u.id = p.user_id 
       WHERE u.email = $1`,
      [email]
    );

    if (result.rows.length === 0) {
      return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ' });
    }

    const user = result.rows[0];

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
    const isValid = await bcrypt.compare(password, user.password_hash);
    if (!isValid) {
      return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ' });
    }

    // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ JWT
    const token = jwt.sign(
      { userId: user.id, email: user.email, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: process.env.JWT_EXPIRES_IN || '7d' }
    );

    res.json({
      token,
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
        fullName: user.full_name
      }
    });

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ' });
  }
});

// ============================================
// MEDICATION ENDPOINTS
// ============================================

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð² Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð°
app.get('/api/medications/:patientId', authenticateToken, async (req, res) => {
  const { patientId } = req.params;

  try {
    const result = await pool.query(
      `SELECT id, name, dosage, scheduled_time, instruction, photo_url, is_active
       FROM medications 
       WHERE patient_id = $1 AND is_active = true
       ORDER BY scheduled_time`,
      [patientId]
    );

    res.json(result.rows);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÐ¿Ð¸ÑÐºÐ° Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²' });
  }
});

// Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ðµ Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²Ð¾
app.post('/api/medications', authenticateToken, async (req, res) => {
  const { patient_id, name, dosage, scheduled_time, instruction } = req.body;

  try {
    const result = await pool.query(
      `INSERT INTO medications (patient_id, name, dosage, scheduled_time, instruction) 
       VALUES ($1, $2, $3, $4, $5) RETURNING *`,
      [patient_id, name, dosage, scheduled_time, instruction]
    );

    res.status(201).json(result.rows[0]);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²Ð°:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²Ð°' });
  }
});

// ============================================
// MEDICATION LOGS (Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ)
// ============================================

// ÐŸÐ°ÐºÐµÑ‚Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² Ð¸Ð· offline-Ñ€ÐµÐ¶Ð¸Ð¼Ð°
app.post('/api/logs/sync', authenticateToken, async (req, res) => {
  const { logs } = req.body; // ÐœÐ°ÑÑÐ¸Ð² Ð»Ð¾Ð³Ð¾Ð²

  try {
    const client = await pool.connect();
    
    try {
      await client.query('BEGIN');

      const insertedLogs = [];

      for (const log of logs) {
        const result = await client.query(
          `INSERT INTO medication_logs (med_id, scheduled_at, actual_at, status, sync_status) 
           VALUES ($1, $2, $3, $4, 'synced') 
           ON CONFLICT DO NOTHING
           RETURNING id`,
          [log.med_id, log.scheduled_at, log.actual_at, log.status]
        );

        if (result.rows.length > 0) {
          insertedLogs.push(result.rows[0].id);
        }
      }

      await client.query('COMMIT');

      res.json({
        message: 'Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°',
        syncedCount: insertedLogs.length
      });

    } catch (err) {
      await client.query('ROLLBACK');
      throw err;
    } finally {
      client.release();
    }

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸' });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸ÐµÐ¼Ð¾Ð² Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´
app.get('/api/logs/:patientId', authenticateToken, async (req, res) => {
  const { patientId } = req.params;
  const { startDate, endDate } = req.query;

  try {
    const result = await pool.query(
      `SELECT ml.*, m.name as medication_name, m.dosage
       FROM medication_logs ml
       JOIN medications m ON ml.med_id = m.id
       WHERE m.patient_id = $1 
       AND ml.scheduled_at BETWEEN $2 AND $3
       ORDER BY ml.scheduled_at DESC`,
      [patientId, startDate, endDate]
    );

    res.json(result.rows);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð²:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸' });
  }
});

// ============================================
// RELATIVE FEED (Ð–Ð¸Ð²Ð°Ñ Ð»ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ Ñ€Ð¾Ð´ÑÑ‚Ð²ÐµÐ½Ð½Ð¸ÐºÐ¾Ð²)
// ============================================
app.get('/api/relative/feed/:relativeId', authenticateToken, async (req, res) => {
  const { relativeId } = req.params;

  try {
    const result = await pool.query(
      `SELECT ml.*, m.name as medication_name, m.dosage, p.full_name as patient_name
       FROM medication_logs ml
       JOIN medications m ON ml.med_id = m.id
       JOIN users u ON m.patient_id = u.id
       JOIN profiles p ON u.id = p.user_id
       JOIN connections c ON c.patient_id = u.id
       WHERE c.relative_id = $1 AND c.status = 'active'
       ORDER BY ml.created_at DESC
       LIMIT 50`,
      [relativeId]
    );

    res.json(result.rows);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð»ÐµÐ½Ñ‚Ñ‹:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð»ÐµÐ½Ñ‚Ñ‹ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹' });
  }
});

// ============================================
// SERVER START
// ============================================
app.listen(PORT, '0.0.0.0', () => {
  console.log('==============================================');
  console.log('ðŸš€ Smart Med Assistant Backend API');
  console.log('==============================================');
  console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://194.87.0.45:${PORT}`);
  console.log(`ðŸ“… Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: ${new Date().toISOString()}`);
  console.log(`ðŸŒ ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: ${process.env.NODE_ENV || 'development'}`);
  console.log('==============================================');
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGTERM. Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹...');
  pool.end(() => {
    console.log('PostgreSQL pool Ð·Ð°ÐºÑ€Ñ‹Ñ‚');
    process.exit(0);
  });
});