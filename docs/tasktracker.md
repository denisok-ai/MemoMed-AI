<!--
  @file: tasktracker.md
  @description: Трекер задач проекта MemoMed AI с приоритетами и статусами
  @dependencies: project.md
  @created: 2026-02-22
-->

# MemoMed AI -- Трекер задач

> Последнее обновление: 2026-02-22 (Q&A решены, задачи уточнены)

**Статусы**: Не начата | В процессе | Завершена | Отложена | Отменена
**Приоритеты**: Критический | Высокий | Средний | Низкий

---

## Этап 1: MVP (v1.0) -- Срок: Апрель 2026

### Задача: Инициализация проекта
- **Статус**: Завершена ✅ (2026-02-22)
- **Приоритет**: Критический
- **Описание**: Создание структуры проекта, настройка Next.js, TypeScript, Tailwind, Prisma, Docker
- **Шаги выполнения**:
  - [x] Инициализация Next.js 16 с App Router и TypeScript
  - [x] Настройка Tailwind CSS v4 и shadcn/ui
  - [x] Настройка Prisma 7 + PostgreSQL schema (12 моделей)
  - [x] Настройка Docker (docker-compose: app, worker, postgres, redis)
  - [x] Настройка ESLint, Prettier, Husky (pre-commit hooks)
  - [x] Настройка Vitest + Testing Library + MSW для тестов
  - [x] Создание базовой структуры папок (src/app, src/components, src/lib)
  - [x] Git init + .gitignore + первый коммит
- **Зависимости**: Нет

### Задача: Аутентификация
- **Статус**: Завершена ✅ (2026-02-22)
- **Приоритет**: Критический
- **Описание**: Регистрация, вход, JWT, роли (patient/relative)
- **Шаги выполнения**:
  - [x] Настройка NextAuth.js v5 (Credentials Provider, JWT-стратегия)
  - [x] Prisma-модели: users, profiles
  - [x] API: POST /api/auth/register
  - [x] API: POST /api/auth/login (через NextAuth signIn)
  - [x] Middleware проверки JWT на защищённых маршрутах
  - [x] Страницы: login, register (адаптивный дизайн, Server Actions)
  - [x] Форма согласия на обработку персональных данных (ФЗ-152) при регистрации
  - [x] Отдельный чекбокс: участие в программе обратной связи (опционально)
  - [x] Хранение токена в httpOnly cookie (JWT через NextAuth)
  - [x] Unit-тесты: валидация, хэширование, JWT (5 тестов)
- **Зависимости**: Инициализация проекта

### Задача: CRUD лекарств
- **Статус**: Завершена ✅ (2026-02-22)
- **Приоритет**: Критический
- **Описание**: Добавление, редактирование, удаление, просмотр лекарств
- **Шаги выполнения**:
  - [x] Prisma-модель: medications (в схеме из предыдущей задачи)
  - [x] API: GET /api/medications (список по пациенту)
  - [x] API: POST /api/medications (создание)
  - [x] API: PATCH /api/medications/:id (редактирование)
  - [x] API: DELETE /api/medications/:id (архивирование, soft delete)
  - [x] Zod-схемы валидации (createMedicationSchema, updateMedicationSchema)
  - [x] Страница: список лекарств (MedicationCard компонент)
  - [x] Страница: форма добавления/редактирования лекарства (MedicationForm)
  - [x] Тесты схем валидации (11 тестов)
- **Зависимости**: Аутентификация

### Задача: Главный экран пациента
- **Статус**: Завершена ✅ (2026-02-22)
- **Приоритет**: Критический
- **Описание**: Экран с часами, названием лекарства и большой кнопкой подтверждения
- **Шаги выполнения**:
  - [x] Компонент: LiveClock (живые часы с русской локалью)
  - [x] Компонент: TakeMedicationButton (большая кнопка, анимация успеха)
  - [x] Компонент: NextMedicationCard (ближайшее лекарство с таймером)
  - [x] Динамический фон: DynamicBackground (градиент по времени суток)
  - [x] Логика: getNextMedication (определение ближайшего лекарства)
  - [x] Запись medication_log при нажатии кнопки (Server Action)
  - [x] Адаптивный дизайн (mobile-first, BottomNav)
  - [x] API: POST /api/logs, POST /api/logs/sync (офлайн-синхронизация)
- **Зависимости**: CRUD лекарств

### Задача: Offline-first (PWA)
- **Статус**: Не начата
- **Приоритет**: Критический
- **Описание**: Работа без интернета через Service Worker и IndexedDB
- **Шаги выполнения**:
  - [ ] Настройка next-pwa (Service Worker, manifest.json)
  - [ ] IndexedDB через Dexie.js: таблицы medications_local, logs_local
  - [ ] Логика: сохранение лога в IndexedDB при нажатии кнопки
  - [ ] Background Sync: отправка pending-логов при появлении сети
  - [ ] Кэширование страниц через Service Worker
  - [ ] Компонент: offline-indicator (индикатор состояния сети)
  - [ ] Hook: useOffline (определение online/offline)
  - [ ] Тесты: offline-сценарий (запись → восстановление → синхронизация)
- **Зависимости**: Главный экран пациента

### Задача: Синхронизация данных
- **Статус**: Не начата
- **Приоритет**: Критический
- **Описание**: Пакетная синхронизация offline-логов с сервером
- **Шаги выполнения**:
  - [ ] Prisma-модель: medication_logs (syncStatus: pending/synced)
  - [ ] API: POST /api/logs/sync (пакетная загрузка)
  - [ ] Логика разрешения конфликтов (Last Write Wins)
  - [ ] Обновление syncStatus в IndexedDB после успешной синхронизации
  - [ ] Тесты: конфликтные сценарии
- **Зависимости**: Offline-first

### Задача: Связь пациент-родственник
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Инвайт-код для связывания аккаунтов
- **Шаги выполнения**:
  - [ ] Prisma-модель: connections
  - [ ] Генерация 12-символьного инвайт-кода при регистрации пациента
  - [ ] API: POST /api/connections/link (привязка по коду)
  - [ ] API: DELETE /api/connections/:id (отключение)
  - [ ] Rate limiting на /api/connections/link (5 попыток в час)
  - [ ] Страница: ввод инвайт-кода (для родственника)
  - [ ] Страница: мой инвайт-код (для пациента)
  - [ ] Тесты: валидация кода, истечение срока, rate limiting
- **Зависимости**: Аутентификация

### Задача: Живая лента для родственника
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Real-time лента событий через Server-Sent Events
- **Шаги выполнения**:
  - [ ] API: GET /api/feed/:relativeId (SSE endpoint)
  - [ ] Компонент: live-feed (список событий с цветовой индикацией)
  - [ ] Компонент: feed-item (событие: время, лекарство, статус, цвет)
  - [ ] Цвета: зелёный (вовремя), жёлтый (опоздание <30мин), красный (пропуск)
  - [ ] Fallback: polling каждые 60 секунд при проблемах с SSE
  - [ ] Тесты: формат событий, цветовая логика
- **Зависимости**: Связь пациент-родственник, Синхронизация данных

### Задача: AI-чат помощник (DeepSeek)
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Чат с AI для ответов на вопросы о лекарствах
- **Шаги выполнения**:
  - [ ] DeepSeek service: `src/lib/ai/deepseek.service.ts` (OpenAI SDK + baseURL)
  - [ ] Системный промпт: `src/lib/ai/prompts/chat.prompt.ts`
  - [ ] API: POST /api/ai/chat (streaming через SSE)
  - [ ] Prisma-модель: chat_messages (серверное хранение истории, 30 дней)
  - [ ] Token budget: Redis counter `ai:tokens:{userId}:{YYYY-MM}`, лимит 50K/месяц
  - [ ] Prisma-модель: ai_usage_stats (агрегированная статистика расхода)
  - [ ] Медицинский дисклеймер: модальное окно при первом использовании чата
  - [ ] Дисклеймер в каждом ответе AI ("При любых сомнениях обратитесь к врачу")
  - [ ] Redis-кэширование ответов на частые вопросы (TTL 1 час)
  - [ ] Rate limiting: 20 запросов / 15 минут на пользователя
  - [ ] Компонент: ai-chat (поле ввода + история сообщений из БД)
  - [ ] Компонент: ai-message-bubble (пузырь с типизацией user/ai)
  - [ ] Быстрые вопросы-подсказки (suggestions)
  - [ ] Страница: /chat
  - [ ] Worker job: очистка chat_messages старше 30 дней
  - [ ] Worker job: ежедневная агрегация token usage → ai_usage_stats
  - [ ] Тесты: streaming, кэширование, rate limiting, token budget
- **Зависимости**: Аутентификация

### Задача: Docker-деплой
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Контейнеризация и деплой на VPS
- **Шаги выполнения**:
  - [ ] Dockerfile для Next.js приложения (multi-stage build)
  - [ ] docker-compose.yml (app, worker, postgres, redis, nginx)
  - [ ] Nginx config (reverse proxy, SSL termination, gzip)
  - [ ] .env.example с описанием переменных
  - [ ] Health check endpoint: GET /api/health
  - [ ] Скрипт деплоя: `scripts/deploy.sh`
  - [ ] Документация: инструкция по деплою
- **Зависимости**: Все задачи этапа 1

---

## Этап 2: Доработки (v1.1) -- Срок: Май 2026

### Задача: Календарь дисциплины
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Визуальный календарь для родственника с цветовой индикацией дней
- **Шаги выполнения**:
  - [ ] API: GET /api/calendar/:patientId?month=YYYY-MM
  - [ ] Компонент: calendar-view (месячная сетка с цветными ячейками)
  - [ ] Логика цветов: зелёный (100%), жёлтый (1-2 пропуска), красный (3+)
  - [ ] Клик по дню → детализация (список лекарств и статусы)
  - [ ] Статистика за месяц (процент дисциплины)
  - [ ] Тесты: расчёт цвета, граничные случаи
- **Зависимости**: Живая лента

### Задача: Web Push напоминания
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Система эскалации уведомлений (T+0, T+10, T+20, T+30)
- **Шаги выполнения**:
  - [ ] Настройка Web Push API (VAPID keys)
  - [ ] Подписка пользователя на push-уведомления
  - [ ] BullMQ worker: reminder.job.ts (4 отложенных задачи на каждый приём)
  - [ ] Логика отмены при подтверждении приема
  - [ ] T+30: push родственнику
  - [ ] Тесты: эскалация, отмена, уведомление родственника
- **Зависимости**: Docker-деплой, Связь пациент-родственник

### Задача: Загрузка фото лекарств
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Фото упаковки для идентификации лекарства
- **Шаги выполнения**:
  - [ ] Компонент: photo-upload (камера + галерея)
  - [ ] API: POST /api/medications/:id/photo (загрузка)
  - [ ] Хранение: локальная файловая система / S3-совместимое хранилище
  - [ ] Оптимизация: сжатие до 500px ширины, WebP
  - [ ] Отображение на карточке лекарства
- **Зависимости**: CRUD лекарств

### Задача: Статистика и дашборд
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Дашборд с метриками дисциплины
- **Шаги выполнения**:
  - [ ] API: GET /api/stats/:patientId (агрегированные данные)
  - [ ] Метрики: процент дисциплины, среднее опоздание, streak
  - [ ] Компонент: stats-dashboard (карточки с метриками)
  - [ ] Графики: тренд дисциплины за 30 дней
- **Зависимости**: Синхронизация данных

### Задача: Онбординг
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Обучающие экраны для новых пользователей (особенно пожилых)
- **Шаги выполнения**:
  - [ ] 3-4 экрана с крупными иллюстрациями и минимумом текста
  - [ ] Показ только при первом входе (флаг в профиле)
  - [ ] Кнопка "Пропустить"
  - [ ] Адаптивный дизайн (mobile-first)
- **Зависимости**: Главный экран пациента

### Задача: Text-to-Speech для напоминаний
- **Статус**: Не начата
- **Приоритет**: Низкий
- **Описание**: Голосовое озвучивание напоминаний через Web Speech API (опциональная настройка)
- **Шаги выполнения**:
  - [ ] Настройка в профиле пользователя: включить/выключить TTS
  - [ ] Интеграция Web Speech API для озвучки уведомлений
  - [ ] Выбор голоса (из доступных системных)
  - [ ] Тесты: совместимость с браузерами
- **Зависимости**: Web Push напоминания

---

## Этап 3: Аналитика (v1.2) -- Срок: Июнь 2026

### Задача: Дневник самочувствия
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Ежедневная запись настроения, боли, сна, энергии
- **Шаги выполнения**:
  - [ ] Prisma-модель: health_journal
  - [ ] API: CRUD для записей дневника
  - [ ] Страница: форма с ползунками (1-5) и свободным текстом
  - [ ] Offline-поддержка через IndexedDB
  - [ ] Тесты: валидация, offline-сохранение
- **Зависимости**: Offline-first

### Задача: Интеграция метеоданных
- **Статус**: Не начата
- **Приоритет**: Низкий
- **Описание**: Получение погодных данных для корреляционного анализа
- **Шаги выполнения**:
  - [ ] Prisma-модель: meteo_logs
  - [ ] Интеграция OpenWeather API (cron: каждые 3 часа)
  - [ ] Worker job: fetch-weather
  - [ ] Хранение: давление, влажность, температура, геомагнитный индекс
- **Зависимости**: Docker-деплой

### Задача: AI-анализ корреляций
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: DeepSeek анализирует связи между симптомами, погодой и лекарствами
- **Шаги выполнения**:
  - [ ] Промпт: analyze.prompt.ts (структурированный анализ)
  - [ ] Worker job: analytics.job.ts (еженедельный анализ по пациенту)
  - [ ] Формат вывода: JSON с выявленными паттернами
  - [ ] Страница: результаты анализа (визуализация)
  - [ ] Кэширование результатов в Redis (TTL 24 часа)
- **Зависимости**: Дневник самочувствия, Интеграция метеоданных

### Задача: Экспорт отчётов для врача
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: PDF-отчёт с историей приёмов и аналитикой
- **Шаги выполнения**:
  - [ ] Промпт: report.prompt.ts (генерация текстового резюме)
  - [ ] Генерация PDF (react-pdf или puppeteer)
  - [ ] API: GET /api/reports/:patientId?period=30d
  - [ ] Содержание: дисциплина, пропуски, симптомы, корреляции
- **Зависимости**: AI-анализ корреляций

### Задача: Сбор обратной связи по лекарствам
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Система сбора отзывов пациентов о лекарствах (бизнес-модель)
- **Шаги выполнения**:
  - [ ] Prisma-модель: medication_feedback
  - [ ] Страница: форма отзыва (эффективность, побочки, свободный текст)
  - [ ] AI-обработка свободного текста (извлечение структурированных данных)
  - [ ] Анонимизация данных перед агрегацией
  - [ ] API: GET /api/feedback/aggregate (для аналитики)
- **Зависимости**: AI-чат помощник

---

## Этап 4: Мобильные приложения (v2.0) -- Срок: Июль 2026

### Задача: Capacitor для Android
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Упаковка PWA в Android-приложение
- **Шаги выполнения**:
  - [ ] Настройка Capacitor
  - [ ] Адаптация: нативные push-уведомления (Firebase)
  - [ ] Адаптация: камера для фото лекарств
  - [ ] Сборка APK / AAB
  - [ ] Публикация в Google Play
- **Зависимости**: Все задачи этапов 1-3

### Задача: Capacitor для iOS
- **Статус**: Не начата
- **Приоритет**: Средний
- **Описание**: Упаковка PWA в iOS-приложение
- **Шаги выполнения**:
  - [ ] Настройка Capacitor для iOS
  - [ ] Адаптация: APNs для push
  - [ ] Сборка IPA
  - [ ] Публикация в App Store
- **Зависимости**: Capacitor для Android

---

## Этап 5: Масштабирование (v2.1) -- Срок: Август 2026

### Задача: Локализация
- **Статус**: Не начата
- **Приоритет**: Низкий
- **Описание**: Английский язык
- **Шаги выполнения**:
  - [ ] Настройка next-intl
  - [ ] Перевод всех строк UI
  - [ ] Перевод системных промптов DeepSeek
- **Зависимости**: Нет

### Задача: Роль "Врач"
- **Статус**: Не начата
- **Приоритет**: Низкий
- **Описание**: Врач может просматривать статистику своих пациентов
- **Шаги выполнения**:
  - [ ] Расширение RBAC: роль doctor
  - [ ] Страница: дашборд врача (список пациентов + метрики)
  - [ ] API: GET /api/doctor/patients
- **Зависимости**: Аутентификация, Статистика

### Задача: Админ-панель
- **Статус**: Не начата
- **Приоритет**: Низкий
- **Описание**: Управление промптами, пользователями, аналитика
- **Шаги выполнения**:
  - [ ] Страница: управление prompt_templates (CRUD)
  - [ ] Страница: список пользователей
  - [ ] Страница: агрегированная аналитика (LLM usage, feedback)
  - [ ] A/B тестирование промптов
- **Зависимости**: Все задачи этапов 1-3

---

## Ссылки

- [Описание проекта](project.md)
- [Дневник разработки](diary.md)
- [Вопросы по архитектуре](qa.md)
