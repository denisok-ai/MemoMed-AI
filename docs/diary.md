<!--
  @file: diary.md
  @description: Дневник наблюдений проекта MemoMed AI -- решения, проблемы, контекст
  @dependencies: project.md, tasktracker.md
  @created: 2026-02-22
-->

# MemoMed AI -- Дневник разработки

> Этот документ обеспечивает бесшовную работу разработчиков.
> Каждая запись содержит контекст принятых решений, выявленных проблем и их решений.

---

## [2026-02-22] Архитектурное проектирование: выбор стека и формирование документации

### Наблюдения

1. **Исходные документы (DOC/) описывают Flutter + Node.js/Express стек**, ориентированный на мобильное приложение. Однако заказчик уточнил, что нужен в первую очередь веб-портал с адаптивным дизайном и возможностью последующей упаковки в мобильные приложения. Это меняет приоритеты.

2. **Заказчик -- начинающий разработчик**. Это значит: стек должен быть единым (один язык), инструменты отладки -- максимально удобными, а архитектура -- не переусложнённой.

3. **DeepSeek выбран как LLM-провайдер** вместо OpenAI. Причина: удобная оплата из РФ. DeepSeek API полностью совместим с OpenAI SDK, поэтому переключение тривиально (замена `baseURL`). Стоимость в ~18 раз ниже GPT-4o.

4. **Бизнес-модель** -- бесплатный сервис для пользователей, монетизация через анонимизированную обратную связь о лекарствах для фармацевтических компаний. Это требует дополнительной таблицы `medication_feedback` и механизма анонимизации.

5. **Обнаружен баг в исходной SQL-схеме** (`DOC/med_assistant_db_schema.sql`, строки 189-197): функция `reset_daily_medication_flags()` сбрасывает `status = 'taken'` на `'pending'` для записей за прошлые дни. Это уничтожает историю приёмов. Логи должны быть иммутабельными.

### Решения

**Решение 1: Next.js вместо Flutter**

Рассмотренные варианты:

| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| Flutter Web + Mobile | Один код для web и mobile | Тяжёлый web-бандл, плохой SEO, Dart -- отдельный язык |
| Next.js + Capacitor | Лучший web-first опыт, TypeScript везде, PWA, огромная экосистема | Capacitor добавляет прослойку для mobile |
| Nuxt.js (Vue) + Capacitor | Проще порог входа, чем React | Меньше экосистема, меньше русскоязычных ресурсов |

**Выбран Next.js** потому что:
- Единый язык TypeScript для фронта и бэка (снижает когнитивную нагрузку)
- Самая большая экосистема и количество обучающих материалов на русском
- PWA из коробки -- offline-first без отдельного мобильного приложения
- Capacitor позволит упаковать в сторы позже
- shadcn/ui предоставляет доступные компоненты (критично для пожилых пользователей)

**Решение 2: Объединённый стек вместо разделённого**

Вместо отдельного Express-бэкенда используем Next.js API Routes для основной логики. Это сокращает количество проектов с двух до одного, упрощает деплой и разработку. Отдельный Worker-сервис оставляем только для фоновых задач (cron, очереди).

**Решение 3: SSE вместо WebSocket для живой ленты**

Server-Sent Events проще в реализации, чем WebSocket, и достаточны для однонаправленного потока данных (сервер → клиент). WebSocket был бы оверинжинирингом для этого случая.

**Решение 4: Prisma ORM вместо raw SQL**

Обеспечивает типобезопасность запросов, автоматические миграции и удобную работу со схемой. Для начинающего разработчика Prisma значительно понятнее, чем raw SQL-запросы.

**Решение 5: Invite-код увеличен до 12 символов**

Исходный 8-символьный код уязвим к перебору. 12 символов + rate limiting (5 попыток в час) делают brute-force непрактичным.

### Проблемы

1. **Offline AI-чат невозможен** -- DeepSeek API требует интернет. В offline-режиме чат будет показывать сообщение "AI-помощник доступен при подключении к интернету" и предлагать кэшированные ответы на частые вопросы.

2. **Web Push не поддерживается в iOS Safari** в полной мере (ограничения Apple). Для iOS-пользователей до упаковки через Capacitor push-напоминания будут работать только при открытом браузере. Это приемлемо для MVP, решится в v2.0 (Capacitor + native push).

3. **Партиционирование medication_logs** -- PostgreSQL партиционирование добавляет сложность. Для MVP откладываем, но закладываем структуру (timestamps на всех записях). Реализуем при достижении >100K записей.

---

## [2026-02-22] Результаты Q&A: все архитектурные вопросы решены

### Наблюдения

1. **Все 15 вопросов из qa.md получили ответы** от заказчика. Большинство рекомендаций приняты без изменений. Отклонений от рекомендаций -- два:
   - Q3 (TTS): рекомендовалось реализовать в MVP, решено отложить на v1.1
   - Q11 (обратная связь): добавлено уточнение -- freemium-модель (минимум бесплатно, глубокая аналитика по подписке)

2. **Бизнес-модель уточнена**: не просто продажа данных, а freemium-аналитика. Бесплатный уровень привлекает фарм-компании, подписка монетизирует глубокие инсайты. Это влияет на архитектуру API обратной связи (нужны разные уровни доступа к агрегированным данным).

3. **Добавлены 2 новые таблицы в схему БД**:
   - `chat_messages` -- серверное хранение истории AI-чата (ранее передавалась с клиента)
   - `ai_usage_stats` -- мониторинг расхода токенов DeepSeek

4. **Token budget определён**: 50 000 токенов/месяц на пользователя. Хранение в Redis (быстрый доступ), агрегация в PostgreSQL (аналитика).

### Решения

**Решение 6: Серверное хранение истории чата вместо клиентского**

Исходный код в DOC/ передавал `conversationHistory` с клиента. Это ненадёжно (теряется при перезагрузке), небезопасно (клиент может подменить историю) и не позволяет анализировать вопросы. Теперь история хранится в таблице `chat_messages` с автоочисткой через 30 дней.

**Решение 7: Freemium-аналитика вместо прямой продажи данных**

Два уровня доступа к агрегированной обратной связи:
- Бесплатный: базовые метрики (средняя оценка, top побочных эффектов)
- Подписка: глубокая сегментация, тренды, корреляции

Это влияет на API: нужен middleware для уровней доступа к `/api/feedback/aggregate`.

**Решение 8: Согласие на данные в MVP**

Форма согласия на обработку персональных данных (ФЗ-152) реализуется сразу в MVP, а не откладывается. Отдельный чекбокс для программы обратной связи. Это правильно с юридической точки зрения и не требует значительных усилий.

### Проблемы

Нет новых проблем. Все открытые вопросы закрыты.

---

*Следующая запись будет добавлена при начале этапа "Инициализация проекта".*
