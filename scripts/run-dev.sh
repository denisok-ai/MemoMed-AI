#!/usr/bin/env bash
# ================================================================
# MemoMed AI — Единая точка входа для запуска в режиме разработки
# ================================================================
# Делает всё необходимое: при первом запуске — настройка, затем — поднятие БД и dev-сервера.
#
# Использование:
#   chmod +x scripts/run-dev.sh
#   ./scripts/run-dev.sh
#
# Для полного тестирования (включая напоминания) во втором терминале:
#   npm run worker:dev
# ================================================================

set -euo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log()  { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_DIR"

echo ""
echo -e "${BLUE}╔════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║   MemoMed AI — Запуск для тестирования    ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════╝${NC}"
echo ""

# Первый запуск: нет .env — выполняем полную настройку
if [ ! -f .env ]; then
  info "Обнаружен первый запуск (нет .env). Выполняю настройку..."
  bash "$SCRIPT_DIR/setup.sh"
  echo ""
fi

# Запуск через существующий скрипт (поднимет postgres+redis при необходимости и npm run dev)
exec bash "$SCRIPT_DIR/start.sh"
